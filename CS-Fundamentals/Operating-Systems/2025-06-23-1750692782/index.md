转载自: [《windows核心编程系列》一 谈谈windows中的错误处理机制](https://www.cnblogs.com/weekbo/p/9054480.html)

# 《windows核心编程系列》一 谈谈windows中的错误处理机制

&nbsp;&nbsp;&nbsp;&nbsp;我们写的函数会用返回值表示程序执行的正确与否，使用void，就意味着程序一定不会出错。Bool类型标识true时为真，false时为假。其他类型根据需要可以定义成不同意义。

&nbsp;&nbsp;&nbsp;&nbsp;Windows除了使用返回值标识函数执行情况，外还引入了错误代码机制。返回值指出函数已发生一个错误。要查看具体是什么错误，就应该使用错误代码。如当我们调用函数打开一个文件，如果打开失败，可能出现多种原因。一是：文件不存在，另一种是该文件被其他程序互斥使用。在这两种情况下都导致文件打开失败，返回值仅仅标识打开失败，但我们不知道原因。这时错误代码就派上用场了。

&nbsp;&nbsp;&nbsp;&nbsp;Windows将错误代码存储于独立于线程的，线程局部存储区中。顾名思义，这个区域是每个线程独有的其他线程无法更改。它存储着一些线程独有的东西，在第二十一章有详细的介绍。在函数执行后，就可以通过调用GetLastError()来获得错误代码。因此这个错误代码永远反映的是上一个函数的执行情况，也就是说它的值是由上一个函数设置的。这就难免发生错误代码被覆盖的情况。如果调用一个函数后，没调用GetLastError就调用其他函数，此时GetLastError返回的是第二个函数的执行情况，而不是第一个，这个要注意。

```
DWORD GetLastError();
```

&nbsp;&nbsp;&nbsp;&nbsp;由函数原型可以知道该函数返回一个DWROD类型的变量。这仅仅是个数字啊，就像当你要访问一个页面，啥也不说就来个404，对于我们来说不成问题，我们知道这是页面不存在或链接错误。但是对于客户来说可能会一脸茫然，以为是电脑坏了呢。404你是知道，610 ，611,612你知道吗？哈哈，这难不到我们程序员兄弟们，网上一搜全搞定。如果不能上网搜你怎么解决呢。

&nbsp;&nbsp;&nbsp;&nbsp;对于GetLastError返回的错误代码，我们不需要考虑这些问题。 VS给我们提供了一个小工具可以将错误代码转换为相应的文本描述。工具--》ErrorLookup。Windows为每个错误代码定义一个宏，如下代码块:
```
#define  ERROR\_SUCCESS             0L
#define  ERROR\_INVALID\_FUNCTION   1L
#define  ERROR\_FILE\_NOT\_FOUND    2L
..........
```

&nbsp;&nbsp;&nbsp;&nbsp;有了这些宏，只看字面意思都可以知道它到底表示的什么意思，而不用死记硬背这些毫无规律的数字了。

&nbsp;&nbsp;&nbsp;&nbsp;一个错误代码对应着一段文本描述，详细的描述错误原因。当我们在自己的程序中检测到一个错误，我们可能需要向用户显示错误的文本描述，而不是一个干巴巴的错误代码，让用户自己去查毕竟不是个好主意。Windows提供一个函数，FormatMesssage可以返回传入的错误代码对应的字符串的首地址。此函数及以后遇到的函数的使用方法不会详细介绍，使用时搜下便知，现在只知道有这样一个函数就可以了。

&nbsp;&nbsp;&nbsp;&nbsp;调用GetLastError仅仅是返回windows定义的错误代码，除此之外windows允许这种机制用于我们自己的函数中。比如，我们写了一个函数供别人调用，可以返回false表示调用失败，还可以使用错误代码来提供更多的信息。通过使用SetLastError可以设置我们认为合适的值。它将线程局部存储区的错误代码设置为我们传递的值，此后调用GetLastError返回的就是我们刚刚设置的值。

&nbsp;&nbsp;&nbsp;&nbsp;`Windows.h`中定义了256个错误代码用以标识256种错误情况，我们在调用SetLastError时，可以传入windows定义过得大部分错误代码，毕竟256中错误情况包含了绝大部分情况。如果所有这些都不能反映你的情况，你可以传入大于255的数作为错误代码。大于255的值是windows留给程序员使用的。

&nbsp;&nbsp;&nbsp;&nbsp;调试程序时，对上一个错误代码进行监视是很有用的。可以在watch窗口中输入$err,hr。它会在value一列显示当前线程的上一个错误代码和该值对应的文本描述。注意是当前线程的哦！！

&nbsp;&nbsp;&nbsp;&nbsp;总结：本章很简单，只需记住GetLastError，FormatMessage，SetLastError就差不多了。
